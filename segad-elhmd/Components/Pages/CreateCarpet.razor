@page "/carpets/create"
@using MediatR
@using Application.DTOs
@using Application.Commands
@using Application.Queries
@inject IMediator Mediator
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Add New Carpet</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2>Add New Carpet</h2>
            
            <div class="card mt-3">
                @if (validationErrors.Any())
                {
                    <div class="alert alert-danger m-3">
                        <ul class="mb-0">
                            @foreach (var error in validationErrors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }
                <div class="card-body">
                    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label class="form-label">Category *</label>
                            <InputSelect @bind-Value="model.CategoryId" class="form-select">
                                <option value="">-- Select Category --</option>
                                @if (categories != null)
                                {
                                    @foreach (var category in categories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => model.CategoryId)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <InputText @bind-Value="model.Name" class="form-control" />
                            <ValidationMessage For="@(() => model.Name)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea @bind-Value="model.Description" class="form-control" rows="3" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Length (meters) *</label>
                                <InputNumber @bind-Value="model.Length" class="form-control" step="0.01" />
                                <ValidationMessage For="@(() => model.Length)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Width (meters) *</label>
                                <InputNumber @bind-Value="model.Width" class="form-control" step="0.01" />
                                <ValidationMessage For="@(() => model.Width)" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Color *</label>
                                <InputText @bind-Value="model.Color" class="form-control" />
                                <ValidationMessage For="@(() => model.Color)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Material *</label>
                                <InputText @bind-Value="model.Material" class="form-control" />
                                <ValidationMessage For="@(() => model.Material)" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price per m² *</label>
                                <InputNumber @bind-Value="model.PricePerSquareMeter" class="form-control" step="0.01" />
                                <ValidationMessage For="@(() => model.PricePerSquareMeter)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock Quantity *</label>
                                <InputNumber @bind-Value="model.StockQuantity" class="form-control" />
                                <ValidationMessage For="@(() => model.StockQuantity)" />
                            </div>
                        </div>

                        @if (model.Length > 0 && model.Width > 0 && model.PricePerSquareMeter > 0)
                        {
                            <div class="alert alert-info">
                                <strong>Calculated:</strong> 
                                Area = @((model.Length * model.Width).ToString("F2")) m² | 
                                Total Price = $@((model.Length * model.Width * model.PricePerSquareMeter).ToString("F2"))
                            </div>
                        }

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                                @(isSubmitting ? "Saving..." : "Save Carpet")
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="Cancel">
                                Cancel
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private CreateCarpetDto model = new();
    private bool isSubmitting = false;
    private List<string> validationErrors = new();
    private IEnumerable<CategoryDto>? categories;

    protected override async Task OnInitializedAsync()
    {
        categories = await Mediator.Send(new GetAllCategoriesQuery());
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            await Mediator.Send(new CreateCarpetCommand(model));
            Navigation.NavigateTo("/carpets");
        }
        catch (FluentValidation.ValidationException ex)
        {
            validationErrors = ex.Errors.Select(e => e.ErrorMessage).ToList();
        }
        catch (Exception ex)
        {
            // In production, use proper logging and user notification
            Console.WriteLine($"Error creating carpet: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/carpets");
    }
}
