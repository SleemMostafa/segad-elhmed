@page "/carpets"
@using MediatR
@using Application.DTOs
@using Application.Queries
@using Application.Commands
@using Application.Resources
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>@SharedResources.Carpets</PageTitle>

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2">
                <i class="bi bi-grid-3x3-gap-fill text-primary"></i>
                @SharedResources.CarpetInventory
            </h1>
            <p class="text-muted">@SharedResources.ManageCarpetStock</p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="NavigateToCreate">
            <i class="bi bi-plus-circle me-2"></i>@SharedResources.AddNewCarpet
        </button>
    </div>
</div>

@if (isLoading)
{
    <div class="loading-container">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">@SharedResources.Loading</span>
        </div>
        <p class="mt-3 text-muted">@SharedResources.LoadingCarpets</p>
    </div>
}
else if (carpets == null || !carpets.Any())
{
    <div class="empty-state">
        <i class="bi bi-inbox" style="font-size: 5rem; color: var(--text-secondary); opacity: 0.5;"></i>
        <h3 class="mt-3">@SharedResources.NoCarpets</h3>
        <p class="text-muted mb-4">@SharedResources.AddFirstCarpet</p>
        <button class="btn btn-primary" @onclick="NavigateToCreate">
            <i class="bi bi-plus-circle me-2"></i>@SharedResources.AddYourFirstCarpet
        </button>
    </div>
}
else
{
    <div class="stats-row mb-4">
        <div class="stat-box">
            <i class="bi bi-box-seam"></i>
            <div>
                <div class="stat-value">@carpets.Count()</div>
                <div class="stat-label">@SharedResources.TotalProducts</div>
            </div>
        </div>
        <div class="stat-box">
            <i class="bi bi-stack"></i>
            <div>
                <div class="stat-value">@carpets.Sum(c => c.StockQuantity)</div>
                <div class="stat-label">@SharedResources.TotalUnits</div>
            </div>
        </div>
        <div class="stat-box">
            <i class="bi bi-currency-dollar"></i>
            <div>
                <div class="stat-value">$@carpets.Sum(c => c.TotalPrice * c.StockQuantity).ToString("N0")</div>
                <div class="stat-label">@SharedResources.TotalValue</div>
            </div>
        </div>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="table modern-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Color</th>
                        <th>Material</th>
                        <th>Dimensions</th>
                        <th>Area</th>
                        <th>Price/m²</th>
                        <th>Total</th>
                        <th>Stock</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var carpet in carpets)
                    {
                        <tr>
                            <td><strong>@carpet.Name</strong></td>
                            <td><span class="badge rounded-pill bg-gradient-secondary">@carpet.CategoryName</span></td>
                            <td>
                                <span class="color-badge" style="background-color: @carpet.Color.ToLower();"></span>
                                @carpet.Color
                            </td>
                            <td>@carpet.Material</td>
                            <td class="text-muted">@carpet.Length.ToString("F2") × @carpet.Width.ToString("F2") m</td>
                            <td>@carpet.Area.ToString("F2") m²</td>
                            <td class="fw-bold">$@carpet.PricePerSquareMeter.ToString("F2")</td>
                            <td class="fw-bold text-success">$@carpet.TotalPrice.ToString("F2")</td>
                            <td>
                                <span class="badge rounded-pill @GetStockBadgeClass(carpet.StockQuantity)">
                                    @carpet.StockQuantity units
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons text-end">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => NavigateToEdit(carpet.Id)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCarpet(carpet.Id)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<style>
    .page-header {
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .loading-container {
        text-align: center;
        padding: 5rem 0;
    }

    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .stat-box {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-box i {
        font-size: 2.5rem;
        color: var(--primary-color);
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .table-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .modern-table {
        margin-bottom: 0;
    }

    .modern-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 1rem;
        border: none;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .modern-table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
    }

    .modern-table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.03);
    }

    .modern-table tbody tr:last-child td {
        border-bottom: none;
    }

    .color-badge {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
        vertical-align: middle;
        margin-right: 0.5rem;
    }

    .bg-gradient-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .action-buttons .btn {
        border-radius: 8px;
    }
</style>

@code {
    private IEnumerable<CarpetDto> carpets = Enumerable.Empty<CarpetDto>();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCarpets();
    }

    private async Task LoadCarpets()
    {
        isLoading = true;
        carpets = await Mediator.Send(new GetAllCarpetsQuery());
        isLoading = false;
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/carpets/create");
    }

    private void NavigateToEdit(Guid id)
    {
        Navigation.NavigateTo($"/carpets/edit/{id}");
    }

    private async Task DeleteCarpet(Guid id)
    {
        var carpet = carpets.FirstOrDefault(c => c.Id == id);
        if (carpet != null)
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Are you sure you want to delete '{carpet.Name}'?");
            
            if (confirmed)
            {
                await Mediator.Send(new DeleteCarpetCommand(id));
                await LoadCarpets();
            }
        }
    }

    private string GetStockBadgeClass(int stock)
    {
        return stock > 5 ? "bg-success" : stock > 0 ? "bg-warning text-dark" : "bg-danger";
    }
}
