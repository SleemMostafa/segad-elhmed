@page "/categories"
@using MediatR
@using Application.Queries
@using Application.Commands
@using Application.DTOs
@inject IMediator Mediator
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Categories</PageTitle>

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2">
                <i class="bi bi-folder-fill text-primary"></i>
                Categories
            </h1>
            <p class="text-muted">Organize your carpet inventory by categories</p>
        </div>
        <a href="/categories/create" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle me-2"></i>New Category
        </a>
    </div>
</div>

@if (categories == null)
{
    <div class="loading-container">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading categories...</p>
    </div>
}
else if (!categories.Any())
{
    <div class="empty-state">
        <i class="bi bi-folder-x" style="font-size: 5rem; color: var(--text-secondary); opacity: 0.5;"></i>
        <h3 class="mt-3">No Categories Yet</h3>
        <p class="text-muted mb-4">Create your first category to start organizing your carpet inventory</p>
        <a href="/categories/create" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Create First Category
        </a>
    </div>
}
else
{
    <div class="row g-4">
        @foreach (var category in categories)
        {
            <div class="col-md-6 col-lg-4">
                <div class="category-card">
                    <div class="category-header">
                        <i class="bi bi-folder-fill"></i>
                        <h5 class="mb-0">@category.Name</h5>
                    </div>
                    <div class="category-body">
                        <p class="category-description">@category.Description</p>
                        <div class="category-stats">
                            <div class="stat-item">
                                <i class="bi bi-box-seam"></i>
                                <span>@category.CarpetsCount items</span>
                            </div>
                            <div class="stat-item">
                                <i class="bi bi-calendar3"></i>
                                <span>@category.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </div>
                        </div>
                    </div>
                    <div class="category-footer">
                        <a href="/categories/edit/@category.Id" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <button class="btn btn-sm btn-outline-danger" 
                                @onclick="() => DeleteCategory(category.Id)" 
                                disabled="@(category.CarpetsCount > 0)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                    @if (category.CarpetsCount > 0)
                    {
                        <div class="category-warning">
                            <i class="bi bi-info-circle"></i>
                            Cannot delete - contains @category.CarpetsCount carpet(s)
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

<style>
    .page-header {
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .loading-container, .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .category-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15);
    }

    .category-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .category-header i {
        font-size: 1.75rem;
    }

    .category-body {
        padding: 1.5rem;
        flex: 1;
    }

    .category-description {
        color: var(--text-secondary);
        margin-bottom: 1rem;
        min-height: 3rem;
    }

    .category-stats {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .stat-item i {
        color: var(--primary-color);
    }

    .category-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #f3f4f6;
        display: flex;
        gap: 0.5rem;
    }

    .category-warning {
        background-color: rgba(251, 191, 36, 0.1);
        color: #92400e;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>

@code {
    private IEnumerable<CategoryDto>? categories;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        categories = await Mediator.Send(new GetAllCategoriesQuery());
    }

    private async Task DeleteCategory(Guid id)
    {
        try
        {
            var result = await Mediator.Send(new DeleteCategoryCommand(id));
            if (result)
            {
                await LoadCategories();
            }
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while deleting the category.";
        }
    }
}
