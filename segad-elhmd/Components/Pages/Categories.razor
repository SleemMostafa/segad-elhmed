@page "/categories"
@using MediatR
@using Application.Queries
@using Application.Commands
@using Application.DTOs
@inject IMediator Mediator
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Categories</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Categories</h1>
        <a href="/categories/create" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Category
        </a>
    </div>

    @if (categories == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!categories.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No categories found. Create your first category to get started!
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Carpets Count</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var category in categories)
                    {
                        <tr>
                            <td><strong>@category.Name</strong></td>
                            <td>@category.Description</td>
                            <td>
                                <span class="badge bg-info">@category.CarpetsCount items</span>
                            </td>
                            <td>@category.CreatedAt.ToString("yyyy-MM-dd")</td>
                            <td>
                                <a href="/categories/edit/@category.Id" class="btn btn-sm btn-warning me-2">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteCategory(category.Id)" 
                                        disabled="@(category.CarpetsCount > 0)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                @if (category.CarpetsCount > 0)
                                {
                                    <small class="text-muted d-block mt-1">Cannot delete - has carpets</small>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }
</div>

@code {
    private IEnumerable<CategoryDto>? categories;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        categories = await Mediator.Send(new GetAllCategoriesQuery());
    }

    private async Task DeleteCategory(Guid id)
    {
        try
        {
            var result = await Mediator.Send(new DeleteCategoryCommand(id));
            if (result)
            {
                await LoadCategories();
            }
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while deleting the category.";
        }
    }
}
